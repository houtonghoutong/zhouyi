# 更新日志

---

## 2026-01-04 12:38 修复线上服务 404 错误

- **问题**: 线上版本在卦象分析时提示 Network Error，API 返回 404 Not Found
- **根因**: 
  1. zhouyi 服务被停止（inactive dead）
  2. 端口 8000 被另一个服务 `ai-dev-journey-portal` 占用
  3. zhouyi 服务无法绑定到 8000 端口
- **修复**:
  1. 将 zhouyi 后端端口从 **8000** 改为 **8001**
  2. 更新 systemd 服务配置：`/etc/systemd/system/zhouyi.service`
  3. 更新 Nginx 配置：`/etc/nginx/sites-available/zhouyi`
  4. 重启 zhouyi 服务和 reload Nginx
- **验证**: `curl http://223.109.142.31:8866/api/divination/methods` 返回正常

---

## 2026-01-03 22:30 修复多个问题

- **问题1**: 线上版本 Network Error（超时）
- **问题2**: 少阳和老阳显示的线条一样，无法区分动爻
- **问题3**: 隐藏模型选择，默认使用 DeepSeek

- **修复**:
  1. **Network Error**: 前端 axios 超时从 60s 增加到 120s
  2. **阳爻/阴爻区分**:
     - 阳爻（少阳、老阳）：一条完整的横线
     - 阴爻（少阴、老阴）：中间断开的两段线
  3. **动爻标记**:
     - 老阳：添加红色 `○` 标记
     - 老阴：添加青色 `×` 标记
     - 动爻名称高亮显示
  4. **隐藏模型选择**: 移除问卦页的 AI 模型选择区域，默认使用 DeepSeek

- **验证**: 线上测试完整流程成功，解读耗时约 90 秒

---

## 2026-01-03 21:50 修复页面跳转问题 & 优化掷铜钱界面设计

- **问题1**: 六爻完成后显示"六爻已成，卦象已定"，但不跳转到结果页
- **问题2**: 铜钱样式是简单的黄色圆圈，不够美观
- **问题3**: 背景太单调，缺乏玄妙神秘感

- **修复与优化**:
  1. **跳转问题**: 增加错误处理和重试机制，确保 API 调用失败时显示具体错误信息和重试按钮
  2. **铜钱设计**: 重新设计为真实的古代方孔圆钱样式
     - 方形孔洞（铜钱特征）
     - "開元通寶"四字排列
     - 金属光泽渐变效果
     - 立体阴影和高光
     - 3D 翻转动画
  3. **神秘背景效果**:
     - 星空闪烁动画
     - 云雾飘动效果（双层错位）
     - 巨大的八卦水印（慢速旋转）
     - 三层能量光环（脉冲扩散）
     - 整体营造玄妙莫测的神秘氛围

- **新增错误处理**: 
  - 显示具体错误信息
  - 提供"重新解卦"按钮
  - 提供"返回重问"按钮

- **验证**: 完整测试通过，从问卦到掷铜钱到AI解读，最终成功跳转到结果页

---

## 2026-01-03 21:35 分享到微信功能

- **需求**: 用户在结果页可以生成分享海报，长按保存后分享到微信
- **实现**:
  1. **新增组件** `SharePoster.vue`:
     - 精美的古风海报设计（深色背景、金色主题）
     - 显示卦象名称、用户问题、吉凶判断
     - 引导文案："测测你的运势"
     - 二维码指向应用首页 `http://223.109.142.31:8866`
     - 使用 `html2canvas` 将 DOM 转换为图片
     - 使用 `qrcode` 生成二维码
  2. **修改** `ResultPage.vue`:
     - 添加醒目的"分享到微信"按钮（绿色，微信风格）
     - 集成 SharePoster 组件
     - 从 A2UI 响应中提取吉凶信息用于海报展示
- **依赖**: `html2canvas`, `qrcode`, `@types/qrcode`
- **使用方式**: 
  1. 完成占卜后，在结果页点击"分享到微信"按钮
  2. 自动生成海报图片
  3. 长按图片保存到相册
  4. 发送给好友或分享到朋友圈

---

## 2026-01-03 21:10 多模型支持：新增 DeepSeek

- **需求**: 支持多 AI 模型，用户可在前端选择使用哪个模型
- **实现**:
  1. **后端架构重构**:
     - 创建 `BaseAIService` 基类（`base_ai_service.py`）
     - 创建 `GeminiService` 继承基类
     - 创建 `DeepSeekService` 继承基类（使用 OpenAI 兼容接口）
     - 创建 `AIServiceFactory` 工厂类（`ai_factory.py`）
  2. **API 新增**:
     - `GET /api/divination/models`: 获取可用模型列表
     - `POST /api/divination/liuyao` 增加 `model` 参数
  3. **前端**:
     - 添加模型选择组件到问卦页面
     - 保存选择到 localStorage
     - 调用 API 时传递模型参数
- **支持的模型**:
  | 模型 | 说明 | 图标 |
  |-----|------|------|
  | gemini | Google Gemini 2.0 Flash | ✨ |
  | deepseek | DeepSeek Chat（国产大模型） | 🔮 |
- **日志**:
  - 日志文件名增加模型标识：`YYYYMMDD_HHMMSS_卦名_模型.md`
  - 日志内容增加模型信息字段
- **验证**: 测试通过，DeepSeek 成功生成 A2UI 格式的卦象解读

---

## 2025-12-31 20:00 实现真正的 A2UI 标准

- **目标**: 实现符合 A2UI 官方标准的动态渲染
- **A2UI 标准流程**: 生成(LLM) → 传输(JSON) → 解析(客户端) → 渲染(原生组件映射)
- **改动**:
  1. **后端**: 重写 Gemini Prompt，让 LLM 直接输出 A2UI JSON（而非文本解读）
  2. **后端**: 新增 `_parse_a2ui_response` 方法，直接解析 Gemini 返回的 JSON
  3. **前端**: 重写 `A2UIRenderer.vue`，支持动态渲染 card/text/badge/list 等组件
  4. **前端**: 添加 "⚡ A2UI 动态渲染" 标识
- **支持的 A2UI 组件类型**:
  - `card`: 卡片组件（支持 elevated/highlighted/warning 变体）
  - `text`: 文本组件（支持 body/caption 样式）
  - `badge`: 徽章组件（支持 success/warning/error/info 颜色）
  - `list`: 列表组件（支持有序/无序列表）
  - `container`: 容器组件（支持 horizontal/vertical 布局）
- **验证**: Gemini 成功生成 A2UI JSON，前端正确渲染所有组件

---

## 2025-12-31 19:55 修复日志保存为 Markdown 格式

- **问题**: 用户要求日志保存为 Markdown 文件，但之前保存为 JSON 格式
- **修复**: 重写 `_save_interaction_log` 方法，输出 `.md` 格式的日志文件
- **日志内容**:
  - 元信息（时间、状态、卦名）
  - 输入参数（问题、卦象、六爻、完整 Prompt）
  - 输出结果（原始响应、解析内容、A2UI JSON）
- **验证**: 测试通过，日志文件 `20251231_175051_天地否.md` 成功生成

---

## 2025-12-31 19:50 A2UI 实现说明

**当前实现与 A2UI 标准的差距**:

| 项目 | A2UI 标准 | 当前实现 |
|------|----------|----------|
| JSON 生成者 | Gemini LLM 直接输出 | 后端代码构建 |
| 组件定义 | LLM 动态决定 | 固定结构 |
| 渲染器 | 解析任意 A2UI JSON | 预定义组件 |

**A2UI 真正流程**: 生成(LLM) → 传输(JSON) → 解析(客户端) → 渲染(原生组件映射)

---

## 2025-12-31 19:40 实现真正的 A2UI 动态渲染

- **问题**: 原先的 `A2UIRenderer.vue` 只是遍历 `data.sections` 渲染固定模板，没有真正使用 A2UI 规范的 `components` 数组
- **改进**: 重写 `A2UIRenderer.vue`，实现真正的 A2UI 动态渲染
  - 递归解析 `components` 数组
  - 根据组件 `type` 字段动态选择渲染方式（card/container/text/custom）
  - 支持嵌套子组件渲染
  - 保留 `sections` 回退机制
- **验证**: 测试通过，页面动态显示来自 `components` 数组的卡片（卦象总论、直白解读、吉凶判断、特别提醒）

---

## 2025-12-31 18:50 添加 AI 交互日志功能

- **需求**: 将 AI 返回的卦象解读 JSON 作为日志保存，记录输入输出参数
- **实现**: 在 `gemini_service.py` 中添加 `_save_interaction_log` 方法
- **日志位置**: `backend/logs/ai_interactions/`
- **日志格式**: JSON 文件，命名为 `YYYYMMDD_HHMMSS_卦名.json`
- **日志内容**:
  - `metadata`: 时间戳、成功状态、错误信息
  - `input`: 用户问题、本卦/变卦信息、六爻详情、完整 prompt
  - `output`: AI 原始响应、解析后的 sections、A2UI 响应

---

## 2025-12-31 18:30 优化卦象解读内容

- **问题**: 用户反馈解读内容不够详细和直白
- **改进**: 
  - 重写 Gemini prompt，要求用"大白话"解读
  - 增加分场景解读（事业/财运/感情/健康）
  - 添加具体可操作的建议
  - 增加"特别提醒"板块，警示风险
- **效果**: 解读内容从简短的术语变成详细的生活化建议，如"千万不要裸辞！"

---

## 2025-12-31 18:00 修复上下卦信息显示问题

- **问题**: 结果页"上卦"和"下卦"名称显示为空
- **原因**: `gemini_service.py` 中仍使用 `snake_case` 字段名（如 `position_name`、`upper_trigram`），与已修改的 `liuyao_service.py` 不一致
- **解决**: 将 `gemini_service.py` 中所有字段引用统一为 `camelCase` 格式
- **验证**: 测试通过，完整显示：水山蹇 | 上卦：坎·水 | 下卦：艮·山

---

## 2025-12-31 17:30 修复卦象显示"未知卦"问题

- **问题**: 结果页显示"未知卦"而非正确卦象名称
- **原因**: 后端 Python 使用 `snake_case` 返回字段（`original_hexagram`），前端 TypeScript 期望 `camelCase`（`originalHexagram`），导致数据解析失败
- **解决**: 在 Pydantic 模型中使用 `Field(..., alias="camelCase")` 别名，确保 API 响应使用 `camelCase` 格式
- **验证**: 测试通过，卦象正确显示为"泽风大过 → 泽水困"

---

## 2025-12-31 17:00 修复六十四卦映射表

- 修正 `liuyao_service.py` 中的 `HEXAGRAMS` 字典
- 按照上卦（外卦）和下卦（内卦）的八卦组合正确映射所有64卦

---

## 2025-12-31 15:30 六爻占卜功能完成

- 完成首页占卜方式选择页面
- 完成六爻占卜问卦输入页面
- 完成掷铜钱交互页面（含动画效果）
- 完成后端 Gemini API + A2UI 卦象生成服务
- 完成卦象结果展示页面（A2UI 动态渲染）
- 实现本地存储历史记录功能

---

## 2025-12-31 14:00 项目初始化

- 创建项目基础结构
- 初始化前端 Vue 3 + TypeScript + Vite 项目
- 初始化后端 Python FastAPI 项目
- 配置 A2UI 集成方案
- 开始开发六爻占卜功能

---

